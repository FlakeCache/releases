name: 'flakecache Nix Installer'
description: 'Install Nix with FlakeCache binary cache - works on GitHub-hosted, self-hosted, and containers'
author: 'flakecache'
branding:
  icon: 'package'
  color: 'blue'

inputs:
  extra-conf:
    description: 'Extra nix.conf configuration lines'
    required: false
    default: ''
  flakecache:
    description: 'Enable FlakeCache binary cache (true/false)'
    required: false
    default: 'true'
  install-cli:
    description: 'Install FlakeCache CLI for push/pull operations'
    required: false
    default: 'false'
  cli-version:
    description: 'FlakeCache CLI version (default: latest)'
    required: false
    default: 'latest'
  extra-substituters:
    description: 'Additional binary cache URLs (space-separated)'
    required: false
    default: ''
  extra-trusted-keys:
    description: 'Additional trusted public keys (space-separated)'
    required: false
    default: ''

outputs:
  nix-path:
    description: 'Path to Nix binary'
    value: ${{ steps.check.outputs.nix-path }}
  already-installed:
    description: 'Whether Nix was already installed'
    value: ${{ steps.check.outputs.installed }}
  cli-path:
    description: 'Path to FlakeCache CLI (if installed)'
    value: ${{ steps.install-cli.outputs.cli-path }}

runs:
  using: 'composite'
  steps:
    - name: Check if Nix already installed
      id: check
      shell: bash
      run: |
        if command -v nix &> /dev/null; then
          echo "installed=true" >> $GITHUB_OUTPUT
          echo "nix-path=$(which nix)" >> $GITHUB_OUTPUT
          echo "âœ… Nix already available (container mode)"
          nix --version
        else
          echo "installed=false" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Nix not found, will install"
        fi
        
        # Check if we should run in container mode
        if [ "$FLAKECACHE_RUNNER" = "true" ] && [ -n "$NIX_CONTAINER_IMAGE" ]; then
          echo "container-mode=true" >> $GITHUB_OUTPUT
          echo "ðŸš€ FlakeCache runner detected, will use container: $NIX_CONTAINER_IMAGE"
        else
          echo "container-mode=false" >> $GITHUB_OUTPUT
        fi

    - name: Install Nix
      if: steps.check.outputs.installed == 'false' && steps.check.outputs.container-mode == 'false'
      shell: bash
      run: |
        echo "ðŸ”§ Installing Nix..."
        
        # Install xz if missing (required for Nix installer)
        if ! command -v xz &> /dev/null; then
          echo "ðŸ“¦ Installing xz-utils..."
          if command -v apt-get &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y xz-utils
          elif command -v apk &> /dev/null; then
            apk add xz
          elif command -v brew &> /dev/null; then
            brew install xz
          else
            echo "âŒ xz not available and no package manager found"
            exit 1
          fi
        fi
        
        # Use daemon mode on macOS, no-daemon on Linux
        if [[ "$OSTYPE" == "darwin"* ]]; then
          curl -L https://nixos.org/nix/install | sh -s -- --daemon
        else
          curl -L https://nixos.org/nix/install | sh -s -- --no-daemon
        fi

        # Add to path for subsequent steps
        if [ -e /nix/var/nix/profiles/default/bin ]; then
          echo "/nix/var/nix/profiles/default/bin" >> $GITHUB_PATH
        fi
        if [ -e "$HOME/.nix-profile/bin" ]; then
          echo "$HOME/.nix-profile/bin" >> $GITHUB_PATH
        fi

        # Source for current step and verify
        if [ -e "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
          . "$HOME/.nix-profile/etc/profile.d/nix.sh"
        fi

        NIX_PATH="${HOME}/.nix-profile/bin/nix"
        if [ -x "$NIX_PATH" ]; then
          echo "nix-path=$NIX_PATH" >> $GITHUB_OUTPUT
          echo "âœ… Nix installed"
          "$NIX_PATH" --version
        else
          echo "âŒ Nix binary not found at expected path"
          exit 1
        fi

    - name: Install Nix (Container Mode)
      if: steps.check.outputs.installed == 'false' && steps.check.outputs.container-mode == 'true'
      shell: bash
      run: |
        echo "ðŸš€ Installing Nix in container mode..."
        echo "ðŸ“¦ Using container: $NIX_CONTAINER_IMAGE"
        
        # For container mode, we assume the container has Nix pre-installed
        # If not, this step would need to run docker commands, but that's complex
        # For now, just set outputs assuming container provides Nix
        echo "nix-path=docker" >> $GITHUB_OUTPUT
        echo "âœ… Container mode enabled"

    - name: Configure Nix
      shell: bash
      run: |
        mkdir -p ~/.config/nix

        # Build substituters list
        SUBSTITUTERS="https://cache.nixos.org"
        TRUSTED_KEYS="cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY="

        # Add FlakeCache if enabled
        if [ "${{ inputs.flakecache }}" = "true" ]; then
          SUBSTITUTERS="https://c.flakecache.com $SUBSTITUTERS"
          TRUSTED_KEYS="c.flakecache.com-1:WbJFKuGbfVpBRT8FyqLrJ+EvGL6YdUrqgyj+X/FVy0I= $TRUSTED_KEYS"
          echo "ðŸ“¦ FlakeCache binary cache enabled"
        fi

        # Add extra substituters
        if [ -n "${{ inputs.extra-substituters }}" ]; then
          SUBSTITUTERS="${{ inputs.extra-substituters }} $SUBSTITUTERS"
        fi

        # Add extra trusted keys
        if [ -n "${{ inputs.extra-trusted-keys }}" ]; then
          TRUSTED_KEYS="${{ inputs.extra-trusted-keys }} $TRUSTED_KEYS"
        fi

        # Write config
        cat > ~/.config/nix/nix.conf << EOF
        experimental-features = nix-command flakes
        accept-flake-config = true
        substituters = $SUBSTITUTERS
        trusted-public-keys = $TRUSTED_KEYS
        fallback = true
        connect-timeout = 5
        EOF

        # Add extra config if provided
        if [ -n "${{ inputs.extra-conf }}" ]; then
          echo "${{ inputs.extra-conf }}" >> ~/.config/nix/nix.conf
        fi

        echo "âœ… Nix configured with flakes enabled"
        echo "ðŸ“¦ Substituters: $SUBSTITUTERS"

    - name: Install FlakeCache CLI
      id: install-cli
      if: inputs.install-cli == 'true'
      shell: bash
      run: |
        echo "ï¿½ï¿½ Installing FlakeCache CLI..."

        # Detect platform
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')
        ARCH=$(uname -m)

        case "$OS" in
          linux)  PLATFORM="linux" ;;
          darwin) PLATFORM="macos" ;;
          *)      echo "âŒ Unsupported OS: $OS"; exit 1 ;;
        esac

        case "$ARCH" in
          x86_64)  ARCH="x86_64" ;;
          aarch64|arm64) ARCH="aarch64" ;;
          *)       echo "âŒ Unsupported arch: $ARCH"; exit 1 ;;
        esac

        BINARY="flakecache-${PLATFORM}-${ARCH}"

        # Get version
        VERSION="${{ inputs.cli-version }}"
        if [ "$VERSION" = "latest" ]; then
          VERSION=$(curl -sL https://api.github.com/repos/FlakeCache/cli/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
        fi

        echo "ðŸ“¥ Downloading FlakeCache CLI $VERSION ($BINARY)..."

        # Download from GitHub releases
        DOWNLOAD_URL="https://github.com/FlakeCache/cli/releases/download/${VERSION}/${BINARY}"
        curl -sL "$DOWNLOAD_URL" -o /tmp/flakecache || {
          echo "âš ï¸ Failed to download FlakeCache CLI (may not be available yet)"
          echo "cli-path=" >> $GITHUB_OUTPUT
          exit 0
        }

        chmod +x /tmp/flakecache
        sudo mv /tmp/flakecache /usr/local/bin/flakecache

        echo "cli-path=/usr/local/bin/flakecache" >> $GITHUB_OUTPUT
        echo "âœ… FlakeCache CLI installed: $(flakecache --version 2>/dev/null || echo $VERSION)"
